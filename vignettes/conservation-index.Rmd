---
title: "Conservation Index"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{Conservation Index}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

This vignette demonstrates conservation index analyses for metabotypes and metabolites.

## Prerequisites

```{r setup, eval=FALSE}
library(MeTime)
library(magrittr)
```

You will need an imputed `metime_analyser` object saved to disk.

## Workflow

```{r, eval=FALSE}
# Load the imputed analyser object.
load("adni_nmr_data")
which_data <- "nmr_data"

res_conservation_index <- adni_nmr_data %>%
  add_distribution_vars_to_rows(
    screening_vars=NULL,
    distribution_vars=c("ADNI_MEM", "ADNI_LAN", "ADNI_EF", "APOEGrp", "DXGrp_longi", "PTGENDER", "Age", "BMI", "PTEDUCAT"),
    which_data=which_data
  ) %>%
  mod_mutate(
    which_data=which_data,
    type="row_data",
    APOEGrp=as.factor(APOEGrp),
    PTGENDER=as.factor(PTGENDER),
    PTEDUCAT=as.factor(PTEDUCAT),
    DXGrp_longi=ifelse(DXGrp_longi == "CN_AD_convert", "AD_converter", DXGrp_longi),
    DXGrp_longi=ifelse(DXGrp_longi == "MCI_AD_convert", "AD_converter", DXGrp_longi)
  ) %>%
  mod_filter(
    which_data=which_data,
    type="row_data",
    !DXGrp_longi %in% c("CN_MCI_convert", "MCI_CN_revert", "mix_AD_stable", "mix_CN_stable", "mix_MCI_stable")
  ) %>%
  mod_trans_zscore(which_data=which_data) %>%
  calc_conservation_metabotype(
    which_data=which_data,
    stratifications=list(time=c("0", "12", "24")),
    verbose=FALSE,
    cols_for_meta=c("ADNI_MEM", "ADNI_LAN", "ADNI_EF", "APOEGrp", "DXGrp_longi", "PTGENDER", "Age", "BMI"),
    name="Conservation_Metabotype_scaled"
  ) %>%
  mod_generate_plots(type="CI_metabotype", interactive=TRUE) %>%
  calc_conservation_metabolite(
    which_data=which_data,
    stratifications=list(time=c("0", "12", "24")),
    verbose=FALSE,
    cols_for_meta=list(biocrates_data=c(id="id", sub_pathway="Class")),
    name="Conservation_Metabolite_scaled"
  ) %>%
  mod_generate_plots(type="CI_metabolite", interactive=TRUE) %>%
  write_report(file="conservation_index.html", title="ADNI NMR Conservation index")
```
